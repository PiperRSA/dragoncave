services:
  edge-traefik:
    image: traefik:v3.1
    container_name: edge-traefik
    labels:
      - "com.centurylinklabs.watchtower.enable=false"
    command:
      - --api.dashboard=true
      - --log.level=INFO
      # Providers
      - --providers.docker=true
      - --providers.docker.endpoint=tcp://dprox:2375
      - --providers.docker.network=edge
      - --providers.docker.exposedbydefault=false
      - --providers.file.directory=/etc/traefik/dynamic
      - --providers.file.watch=true
      # Entrypoints
      - --entrypoints.web.address=:80
      - --entrypoints.web.http.redirections.entrypoint.to=websecure
      - --entrypoints.web.http.redirections.entrypoint.scheme=https
      - --entrypoints.web.http.redirections.entrypoint.permanent=true
      - --entrypoints.websecure.address=:443
      # ACME via Cloudflare DNS-01
      - --certificatesresolvers.cloudflare.acme.email=admin@hexwyrm.com
      - --certificatesresolvers.cloudflare.acme.storage=/letsencrypt/acme.json
      - --certificatesresolvers.cloudflare.acme.keytype=RSA4096
      - --certificatesresolvers.cloudflare.acme.dnschallenge.provider=cloudflare
      - --certificatesresolvers.cloudflare.acme.dnschallenge.delaybeforecheck=1m
    env_file:
      - /opt/dragoncave/secrets/cloudflare.env
    ports:
      - "80:80"
      - "443:443"
    volumes:
      # Docker socket now proxied via dprox on the core network
      - /opt/dragoncave/configs/traefik:/etc/traefik/dynamic:ro
      - /opt/dragoncave/data/letsencrypt:/letsencrypt
      - /opt/dragoncave/secrets/traefik_basicauth.htpasswd:/run/secrets/traefik_basicauth:ro
    networks:
      edge:
        aliases:
          - traefik
      core:
        aliases:
          - traefik
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped

networks:
  edge:
    external: true
  core:
    external: true
